# ๐ ุชูุฑูุฑ ุดุงูู: ูุธุงู ุญุณุงุจ ุงูุจุตูุงุช ูุงูุฑูุงุชุจ ูู MASSAR 1.02

## ๐ ุฌุฏูู ุงููุญุชููุงุช
1. [ูุธุฑุฉ ุนุงูุฉ](#ูุธุฑุฉ-ุนุงูุฉ)
2. [ูููู ูุงุนุฏุฉ ุงูุจูุงูุงุช](#ูููู-ูุงุนุฏุฉ-ุงูุจูุงูุงุช)
3. [Workflow ุงููุงูู](#workflow-ุงููุงูู)
4. [Business Logic - ูุนุงูุฌุฉ ุงูุจุตูุงุช](#business-logic---ูุนุงูุฌุฉ-ุงูุจุตูุงุช)
5. [Business Logic - ุญุณุงุจ ุงูุฑูุงุชุจ](#business-logic---ุญุณุงุจ-ุงูุฑูุงุชุจ)
6. [ุฃููุงุน ุงูุฑูุงุชุจ](#ุฃููุงุน-ุงูุฑูุงุชุจ)
7. [ุงูุงุณุชุซูุงุกุงุช ูุงูุฃุฎุทุงุก](#ุงูุงุณุชุซูุงุกุงุช-ูุงูุฃุฎุทุงุก)
8. [ุงููุธุงุฆู ุบูุฑ ุงููุชุฒุงููุฉ (Jobs)](#ุงููุธุงุฆู-ุบูุฑ-ุงููุชุฒุงููุฉ-jobs)
9. [ุงูุชุฎุฒูู ุงููุคูุช (Caching)](#ุงูุชุฎุฒูู-ุงููุคูุช-caching)

---

## ๐ฏ ูุธุฑุฉ ุนุงูุฉ

ูุธุงู MASSAR 1.02 ูุณุชุฎุฏู ูุธุงูุงู ูุชูุฏูุงู ููุนูุฏุงู ููุนุงูุฌุฉ ุงูุจุตูุงุช ูุญุณุงุจ ุงูุฑูุงุชุจ. ุงููุธุงู ูุจูู ุนูู **Laravel 12** ู **Livewire 3** ููุณุชุฎุฏู **Modular Monolith Architecture**.

### ุงูููููุงุช ุงูุฑุฆูุณูุฉ:
- **AttendanceProcessingService**: ุฎุฏูุฉ ูุนุงูุฌุฉ ุงูุจุตูุงุช
- **SalaryCalculationService**: ุฎุฏูุฉ ุญุณุงุจ ุงูุฑูุงุชุจ
- **AttendanceProcessingManager**: ูููู Livewire ูุฅุฏุงุฑุฉ ุงููุนุงูุฌุฉ
- **Jobs**: ูุธุงุฆู ุบูุฑ ูุชุฒุงููุฉ ูููุนุงูุฌุฉ ุงููุจูุฑุฉ

---

## ๐๏ธ ูููู ูุงุนุฏุฉ ุงูุจูุงูุงุช

### 1. ุฌุฏูู `attendances` (ุงูุจุตูุงุช)
```sql
- id: ูุนุฑู ุงูุจุตูุฉ
- employee_id: ูุนุฑู ุงูููุธู
- type: ููุน ุงูุจุตูุฉ (check_in, check_out)
- date: ุชุงุฑูุฎ ุงูุจุตูุฉ
- time: ููุช ุงูุจุตูุฉ
- location: ูููุน ุงูุจุตูุฉ (JSON)
- status: ุญุงูุฉ ุงูุจุตูุฉ
- branch_id: ูุนุฑู ุงููุฑุน
```

### 2. ุฌุฏูู `attendance_processings` (ุงููุนุงูุฌุงุช)
```sql
- id: ูุนุฑู ุงููุนุงูุฌุฉ
- type: ููุน ุงููุนุงูุฌุฉ (single, multiple, department)
- employee_id: ูุนุฑู ุงูููุธู
- department_id: ูุนุฑู ุงููุณู
- period_start: ุชุงุฑูุฎ ุจุฏุงูุฉ ุงููุชุฑุฉ
- period_end: ุชุงุฑูุฎ ููุงูุฉ ุงููุชุฑุฉ
- total_days: ุฅุฌูุงูู ุงูุฃูุงู
- working_days: ุฃูุงู ุงูุนูู
- actual_work_days: ุฃูุงู ุงูุนูู ุงููุนููุฉ
- overtime_work_days: ุฃูุงู ุงูุนูู ุงูุฅุถุงููุฉ
- absent_days: ุฃูุงู ุงูุบูุงุจ
- total_hours: ุฅุฌูุงูู ุงูุณุงุนุงุช
- actual_work_hours: ุณุงุนุงุช ุงูุนูู ุงููุนููุฉ
- overtime_work_minutes: ุฏูุงุฆู ุงูุนูู ุงูุฅุถุงููุฉ
- total_late_minutes: ุฅุฌูุงูู ุฏูุงุฆู ุงูุชุฃุฎูุฑ
- calculated_salary_for_day: ุงูุฑุงุชุจ ุงููุญุณูุจ ููููู
- calculated_salary_for_hour: ุงูุฑุงุชุจ ุงููุญุณูุจ ููุณุงุนุฉ
- employee_productivity_salary: ุฑุงุชุจ ุงูุฅูุชุงุฌูุฉ
- salary_due: ุงูุฑุงุชุจ ุงููุณุชุญู
- total_salary: ุฅุฌูุงูู ุงูุฑุงุชุจ
- status: ุงูุญุงูุฉ (pending, approved, rejected)
- notes: ููุงุญุธุงุช
```

### 3. ุฌุฏูู `attendance_processing_details` (ุชูุงุตูู ุงููุนุงูุฌุฉ)
```sql
- id: ูุนุฑู ุงูุชูุตูู
- attendance_processing_id: ูุนุฑู ุงููุนุงูุฌุฉ
- employee_id: ูุนุฑู ุงูููุธู
- attendance_date: ุชุงุฑูุฎ ุงูุญุถูุฑ
- attendance_status: ุญุงูุฉ ุงูุญุถูุฑ (present, absent, paid_leave, unpaid_leave, half_day, holiday)
- day_type: ููุน ุงูููู (working_day, overtime_day, holiday)
- shift_start_time: ููุช ุจุฏุงูุฉ ุงูููุงูุจุฉ
- shift_end_time: ููุช ููุงูุฉ ุงูููุงูุจุฉ
- check_in_time: ููุช ุงูุฏุฎูู
- check_out_time: ููุช ุงูุฎุฑูุฌ
- attendance_basic_hours_count: ุนุฏุฏ ุงูุณุงุนุงุช ุงูุฃุณุงุณูุฉ
- attendance_actual_hours_count: ุนุฏุฏ ุงูุณุงุนุงุช ุงููุนููุฉ
- attendance_overtime_minutes_count: ุนุฏุฏ ุฏูุงุฆู ุงูุฅุถุงูู
- attendance_late_minutes_count: ุนุฏุฏ ุฏูุงุฆู ุงูุชุฃุฎูุฑ
- total_due_hourly_salary: ุงูุฑุงุชุจ ุงููููู ุงููุณุชุญู
```

---

## ๐ Workflow ุงููุงูู

### ุงููุฑุญูุฉ 1: ุจุฏุก ุงููุนุงูุฌุฉ
```
ุงููุณุชุฎุฏู โ AttendanceProcessingManager (Livewire)
    โ
ุงุฎุชูุงุฑ ููุน ุงููุนุงูุฌุฉ (single/multiple/department)
    โ
ุงุฎุชูุงุฑ ุงููุชุฑุฉ (startDate, endDate)
    โ
ุงุฎุชูุงุฑ ุงูููุธู/ุงูููุธููู/ุงููุณู
    โ
ุฅุฑุณุงู ุงููููุฐุฌ โ processAttendance()
```

### ุงููุฑุญูุฉ 2: ุงูุชุญูู ูุงูุชุญูู ูู ุงูุชุฏุงุฎู
```
AttendanceProcessingManager::processAttendance()
    โ
ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช (Validation)
    โ
AttendanceProcessingService::processSingleEmployee/Multiple/Department
    โ
ุงูุชุญูู ูู ุญุงูุฉ ุงูููุธู (ูุดุท/ูุนุทู)
    โ
ุงูุชุญูู ูู ุงูุชุฏุงุฎู (Overlap Check)
    โโ ุฅุฐุง ูุงู ููุงู ุชุฏุงุฎู โ ุฅุฑุฌุงุน ุฎุทุฃ ููุตู
    โโ ุฅุฐุง ูู ููู ููุงู ุชุฏุงุฎู โ ุงููุชุงุจุนุฉ
```

### ุงููุฑุญูุฉ 3: ูุนุงูุฌุฉ ุงูุจูุงูุงุช
```
AttendanceProcessingService::processEmployeeData()
    โ
DB::beginTransaction()
    โ
AttendanceProcessingService::processEmployeeAttendance()
    โ
SalaryCalculationService::calculateSalary()
    โ
ูุนุงูุฌุฉ ูู ููู ูู ุงููุชุฑุฉ:
    โโ ุชุญุฏูุฏ ููุน ุงูููู (working_day/overtime_day/holiday)
    โโ ุงูุชุญูู ูู ุงูุฅุฌุงุฒุงุช (paid_leave/unpaid_leave)
    โโ ูุนุงูุฌุฉ ุงูุจุตูุงุช (check_in/check_out)
    โโ ุญุณุงุจ ุงูุณุงุนุงุช (actual_hours/overtime_minutes/late_minutes)
    โโ ุชุญุฏูุฏ ุญุงูุฉ ุงูููู (present/absent/half_day)
    โ
ุญุณุงุจ ุงูุฑุงุชุจ ุญุณุจ ููุน ุงูุฑุงุชุจ
    โ
ุฅูุดุงุก ุณุฌู AttendanceProcessing
    โ
ุฅูุดุงุก ุณุฌูุงุช AttendanceProcessingDetail (ููู ููู)
    โ
DB::commit()
```

### ุงููุฑุญูุฉ 4: ุงูููุงููุฉ/ุงูุฑูุถ
```
ุงููุณุชุฎุฏู โ approveProcessing() / rejectProcessing()
    โ
ุฅุฐุง ูุงูุช ุงูููุงููุฉ:
    โโ ุงูุชุญูู ูู ุงูุฑุงุชุจ (ุฅุฐุง ูุงู ุณุงูุจุงู โ ูุง ูุชู ุฅูุดุงุก ููุฏ ูุญุงุณุจู)
    โโ ุฅุฐุง ูุงู ููุฌุจุงู โ ุฅูุดุงุก ููุฏ ูุญุงุณุจู (Journal Entry)
        โโ debit: ุญุณุงุจ 5301 (ูุตุฑููุงุช ุงูุฑูุงุชุจ)
        โโ credit: ุญุณุงุจ ุงูููุธู
    โ
ุชุญุฏูุซ ุญุงูุฉ ุงููุนุงูุฌุฉ ุฅูู 'approved'
```

---

## ๐งฎ Business Logic - ูุนุงูุฌุฉ ุงูุจุตูุงุช

### 1. ุชุญุฏูุฏ ููุน ุงูููู (Day Type)

```php
// SalaryCalculationService::dayType()

if (ุงูููู ูู ุฃูุงู ุงูุนูู ุงููุญุฏุฏุฉ ูู ุงูููุงูุจุฉ) {
    return 'working_day';
} elseif (ุงูููู ููุณ ูู ุฃูุงู ุงูุนูู && ูุง ุชูุฌุฏ ุจุตูุงุช) {
    return 'holiday';
} elseif (ุงูููู ููุณ ูู ุฃูุงู ุงูุนูู && ุชูุฌุฏ ุจุตูุงุช) {
    return 'overtime_day';
}
```

### 2. ูุนุงูุฌุฉ ุจุตูุฉ ุงูููู (Process Day Attendance)

#### ุฃ. ุงูุชุญูู ูู ุงูุฅุฌุงุฒุงุช
```php
// ุฃููุงู: ุงูุชุญูู ูู ุงูุฅุฌุงุฒุงุช ุงููุฏููุนุฉ
if (hasApprovedPaidLeave && !validCheckIn) {
    return [
        'status' => 'paid_leave',
        'actual_hours' => expectedHours, // ูุญุตู ุนูู ุณุงุนุงุช ูุงููุฉ
    ];
}

// ุซุงููุงู: ุงูุชุญูู ูู ุงูุฅุฌุงุฒุงุช ุบูุฑ ุงููุฏููุนุฉ
if (hasApprovedUnpaidLeave && !validCheckIn) {
    return [
        'status' => 'unpaid_leave',
        'actual_hours' => 0, // ูุง ูุญุตู ุนูู ุณุงุนุงุช
    ];
}
```

#### ุจ. ูุนุงูุฌุฉ ุงูุจุตูุงุช ุญุณุจ ููุน ุงูุฑุงุชุจ

##### 1๏ธโฃ **ุณุงุนุงุช ุนูู ููุท** (`ุณุงุนุงุช ุนูู ููุท`)
```php
if (validCheckIn && checkOut) {
    return [
        'status' => 'present',
        'actual_hours' => expectedHours, // ููู ูุงูู ููุท
        'overtime_minutes' => 0, // ูุง ููุฌุฏ ุฅุถุงูู
        'late_minutes' => 0, // ูุง ููุญุณุจ ุงูุชุฃุฎูุฑ
    ];
}
```

##### 2๏ธโฃ **ุณุงุนุงุช ุนูู ูุฅุถุงูู ูููู** (`ุณุงุนุงุช ุนูู ู ุฅุถุงูู ูููู`)
```php
if (validCheckIn && checkOut) {
    $basicHours = expectedHours;
    
    // ุงูุฅุถุงูู ููุญุณุจ ููุท ุฅุฐุง ูุงูุช ุจุตูุฉ ุงูุฎุฑูุฌ ุจุนุฏ ending_check_out
    if (checkOut > ending_check_out) {
        $overtimeMinutes = calculateOvertimeAfterEndTime();
    }
    
    $lateMinutes = calculateLateMinutes();
    
    return [
        'status' => 'present',
        'actual_hours' => $basicHours,
        'overtime_minutes' => $overtimeMinutes,
        'late_minutes' => $lateMinutes,
    ];
}
```

##### 3๏ธโฃ **ุณุงุนุงุช ุนูู ูุฅุถุงูู ูููุฏุฉ** (`ุณุงุนุงุช ุนูู ู ุฅุถุงูู ูููุฏู`)
```php
// ููุณ ููุทู "ุฅุถุงูู ูููู"
// ุงููุฑู ูู ุญุณุงุจ ุงูุฑุงุชุจ ููุท
```

##### 4๏ธโฃ **ุญุถูุฑ ููุท** (`ุญุถูุฑ ููุท`)
```php
if (validCheckIn) {
    return [
        'status' => 'present',
        'actual_hours' => expectedHours, // ููู ูุงูู ุญุชู ุจุฏูู ุจุตูุฉ ุฎุฑูุฌ
        'overtime_minutes' => 0,
        'late_minutes' => 0, // ูุง ููุญุณุจ ุงูุชุฃุฎูุฑ
    ];
}
```

##### 5๏ธโฃ **ุฅูุชุงุฌ ููุท** (`ุฅูุชุงุฌ ููุท`)
```php
if (anyCheckIn) {
    return [
        'status' => 'present',
        'actual_hours' => expectedHours, // ููุนุฑุถ ููุท
        'notes' => 'ุงูุฑุงุชุจ ุจูุงุกู ุนูู ุงูุฅูุชุงุฌ ูููุณ ุณุงุนุงุช ุงูุญุถูุฑ',
    ];
}
```

#### ุฌ. ุญุงูุงุช ุฎุงุตุฉ

##### ูุตู ููู (Half Day)
```php
if (!validCheckIn && checkIns->isNotEmpty() && checkOuts->isNotEmpty()) {
    // ุจุตูุฉ ุฏุฎูู ูุชุฃุฎุฑุฉ (ุจุนุฏ ending_check_in) + ุจุตูุฉ ุฎุฑูุฌ
    return [
        'status' => 'half_day',
        'actual_hours' => expectedHours / 2,
        'late_minutes' => calculateLateMinutes(),
    ];
}
```

##### ุบูุงุจ (Absent)
```php
if (!validCheckIn && !checkOut && !paidLeave && !unpaidLeave && dayType == 'working_day') {
    return [
        'status' => 'absent',
        'actual_hours' => 0,
    ];
}
```

### 3. ุญุณุงุจ ุงูุณุงุนุงุช

#### ุงูุณุงุนุงุช ุงููุนููุฉ (Actual Hours)
```php
// ุชุนุชูุฏ ุนูู ููุน ุงูุฑุงุชุจ:
- 'ุณุงุนุงุช ุนูู ููุท': expectedHours (ุซุงุจุช)
- 'ุณุงุนุงุช ุนูู ู ุฅุถุงูู ูููู': expectedHours (ุซุงุจุช) + overtime
- 'ุญุถูุฑ ููุท': expectedHours (ุซุงุจุช)
- 'ุฅูุชุงุฌ ููุท': expectedHours (ููุนุฑุถ ููุท)
```

#### ุณุงุนุงุช ุงูุฅุถุงูู (Overtime Minutes)
```php
// ููุญุณุจ ููุท ุฅุฐุง:
1. checkOut > shift->end_time
2. checkOut > shift->ending_check_out (ูุฃููุงุน ูุนููุฉ)
3. actualHours > expectedHours (ูู ุจุนุถ ุงูุญุงูุงุช)

$overtimeMinutes = (checkOutTime - endTime) in minutes;
```

#### ุฏูุงุฆู ุงูุชุฃุฎูุฑ (Late Minutes)
```php
// ููุญุณุจ ููุท ุฅุฐุง:
1. checkIn > shift->start_time
2. checkIn <= shift->ending_check_in (ูู ุงููุทุงู ุงููุณููุญ)

$lateMinutes = (checkInTime - startTime) in minutes;
```

---

## ๐ฐ Business Logic - ุญุณุงุจ ุงูุฑูุงุชุจ

### 1. ุญุณุงุจ ุงููุนุฏูุงุช ุงูุฃุณุงุณูุฉ

```php
// ูุนุฏู ุงูุณุงุนุฉ
$currentMonthDays = now()->daysInMonth; // 30 ุฃู 31
$shiftHours = getExpectedHours($employee); // ูู ุงูููุงูุจุฉ
$hourlyRate = $employee->salary / $currentMonthDays / $shiftHours;

// ูุนุฏู ุงูููู
$dailyRate = $employee->salary / $currentMonthDays;
```

### 2. ุญุณุงุจ ุงูุฑุงุชุจ ุญุณุจ ุงูููุน

#### ุฃ. **ุณุงุนุงุช ุนูู ููุท** (`ุณุงุนุงุช ุนูู ููุท`)

```php
// ุงูุฑุงุชุจ ุงูุฃุณุงุณู
$basicSalary = $summary['actual_hours'] * $hourlyRate;

// ุฑุงุชุจ ุงูุฅุถุงูู (ุณุงุนุงุช)
$overtimeSalary = ($summary['overtime_minutes'] / 60) * $hourlyRate * ($employee->additional_hour_calculation ?? 1.5);

// ุฑุงุชุจ ุงูุฅุถุงูู (ุฃูุงู - ูุซู ุงูุนุทูุงุช)
$overtimeDaysSalary = ($summary['overtime_days'] ?? 0) * $dailyRate * ($employee->additional_day_calculation ?? 1.5);

// ุงูุฎุตููุงุช
$unpaidLeaveDeduction = ($summary['unpaid_leave_days'] ?? 0) * $dailyRate;
$lateDayCalculation = $employee->late_day_calculation ?? 1.0;
$absentDaysDeduction = ($summary['absent_days'] ?? 0) * $lateDayCalculation * $dailyRate;

// ุงูุฅุฌูุงูู
$totalSalary = $basicSalary + $overtimeSalary + $overtimeDaysSalary - $unpaidLeaveDeduction - $absentDaysDeduction;
```

#### ุจ. **ุณุงุนุงุช ุนูู ูุฅุถุงูู ูููู** (`ุณุงุนุงุช ุนูู ู ุฅุถุงูู ูููู`)

```php
// ููุณ ุญุณุงุจ "ุณุงุนุงุช ุนูู ููุท" + ุฎุตู ุงูุชุฃุฎูุฑ

$basicSalary = $summary['actual_hours'] * $hourlyRate;
$overtimeSalary = ($summary['overtime_minutes'] / 60) * $hourlyRate * ($employee->additional_hour_calculation ?? 1.5);
$overtimeDaysSalary = ($summary['overtime_days'] ?? 0) * $dailyRate * ($employee->additional_day_calculation ?? 1.5);

// ุฎุตู ุงูุชุฃุฎูุฑ (ุณุงุนุงุช)
$lateHourCalculation = $employee->late_hour_calculation ?? 1.0;
$lateHoursDeduction = ($summary['late_minutes'] / 60) * $lateHourCalculation;
$lateDeductionAmount = $lateHoursDeduction * $hourlyRate;

// ุงูุฎุตููุงุช ุงูุฃุฎุฑู
$unpaidLeaveDeduction = ($summary['unpaid_leave_days'] ?? 0) * $dailyRate;
$lateDayCalculation = $employee->late_day_calculation ?? 1.0;
$absentDaysDeduction = ($summary['absent_days'] ?? 0) * $lateDayCalculation * $dailyRate;

// ุงูุฅุฌูุงูู
$totalSalary = $basicSalary + $overtimeSalary + $overtimeDaysSalary - $lateDeductionAmount - $unpaidLeaveDeduction - $absentDaysDeduction;
```

#### ุฌ. **ุณุงุนุงุช ุนูู ูุฅุถุงูู ูููุฏุฉ** (`ุณุงุนุงุช ุนูู ู ุฅุถุงูู ูููุฏู`)

```php
// ููุณ ููุทู "ุฅุถุงูู ูููู"
// ุงููุฑู ูู ุงูุชุทุจูู ุงูุนููู ููุท
```

#### ุฏ. **ุญุถูุฑ ููุท** (`ุญุถูุฑ ููุท`)

```php
// ุงูุฑุงุชุจ ุงูุฃุณุงุณู (ุญุณุจ ุงูุฃูุงู ููุท)
$attendanceSalary = $summary['present_days'] * $dailyRate;

// ุงูุฎุตููุงุช
$unpaidLeaveDeduction = ($summary['unpaid_leave_days'] ?? 0) * $dailyRate;
$lateDayCalculation = $employee->late_day_calculation ?? 1.0;
$absentDaysDeduction = ($summary['absent_days'] ?? 0) * $lateDayCalculation * $dailyRate;

// ุงูุฅุฌูุงูู
$totalSalary = $attendanceSalary - $unpaidLeaveDeduction - $absentDaysDeduction;
```

#### ูู. **ุฅูุชุงุฌ ููุท** (`ุฅูุชุงุฌ ููุท`)

```php
// ุงูุฑุงุชุจ ูุง ููุญุณุจ ููุง
// ููุญุณุจ ูุงุญูุงู ุจูุงุกู ุนูู ูุนุงุฏูุฉ ุงูุฅูุชุงุฌ

return [
    'basic_salary' => 0,
    'overtime_salary' => 0,
    'total_salary' => 0,
    'calculation_type' => 'production_only',
];
```

### 3. ูุนุงููุงุช ุงูุญุณุงุจ (Employee Fields)

#### `additional_hour_calculation`
- **ุงูุงูุชุฑุงุถู**: 1.5
- **ุงูุงุณุชุฎุฏุงู**: ูุถุงุนู ุฑุงุชุจ ุงูุณุงุนุฉ ุงูุฅุถุงููุฉ
- **ูุซุงู**: ุฅุฐุง ูุงู 1.5ุ ูุงูุณุงุนุฉ ุงูุฅุถุงููุฉ = ุณุงุนุฉ ุนุงุฏูุฉ ร 1.5

#### `additional_day_calculation`
- **ุงูุงูุชุฑุงุถู**: 1.5
- **ุงูุงุณุชุฎุฏุงู**: ูุถุงุนู ุฑุงุชุจ ุงูููู ุงูุฅุถุงูู (ุนุทูุงุช/ุฃูุงู ุฅุถุงููุฉ)
- **ูุซุงู**: ุฅุฐุง ูุงู 1.5ุ ูุงูููู ุงูุฅุถุงูู = ููู ุนุงุฏู ร 1.5

#### `late_hour_calculation`
- **ุงูุงูุชุฑุงุถู**: 1.0
- **ุงูุงุณุชุฎุฏุงู**: ุนุฏุฏ ุงูุณุงุนุงุช ุงูุชู ุชูุฎุตู ููู ุณุงุนุฉ ุชุฃุฎูุฑ
- **ูุซุงู**: ุฅุฐุง ูุงู 0.5ุ ูุณุงุนุฉ ุชุฃุฎูุฑ ูุงุญุฏุฉ = ุฎุตู 0.5 ุณุงุนุฉ

#### `late_day_calculation`
- **ุงูุงูุชุฑุงุถู**: 1.0
- **ุงูุงุณุชุฎุฏุงู**: ุนุฏุฏ ุงูุฃูุงู ุงูุชู ุชูุฎุตู ููู ููู ุบูุงุจ
- **ูุซุงู**: ุฅุฐุง ูุงู 2.0ุ ูููู ุบูุงุจ ูุงุญุฏ = ุฎุตู ููููู

---

## ๐ ุฃููุงุน ุงูุฑูุงุชุจ

| ุงูููุน | ุงููุตู | ุญุณุงุจ ุงูุณุงุนุงุช | ุญุณุงุจ ุงูุฅุถุงูู | ุญุณุงุจ ุงูุชุฃุฎูุฑ |
|------|------|-------------|-------------|-------------|
| **ุณุงุนุงุช ุนูู ููุท** | ูุญุณุจ ุงูุณุงุนุงุช ููุท ุจุฏูู ุฅุถุงูู | ููู ูุงูู (expectedHours) | ูุง ููุฌุฏ | ูุง ููุญุณุจ |
| **ุณุงุนุงุช ุนูู ูุฅุถุงูู ูููู** | ูุญุณุจ ุงูุณุงุนุงุช + ุฅุถุงูู ูููู | ููู ูุงูู (expectedHours) | ุจุนุฏ ending_check_out | ููุญุณุจ |
| **ุณุงุนุงุช ุนูู ูุฅุถุงูู ูููุฏุฉ** | ููุณ "ุฅุถุงูู ูููู" | ููู ูุงูู (expectedHours) | ุจุนุฏ ending_check_out | ููุญุณุจ |
| **ุญุถูุฑ ููุท** | ูุญุณุจ ุญุณุจ ุงูุฃูุงู ููุท | ููู ูุงูู (expectedHours) | ูุง ููุฌุฏ | ูุง ููุญุณุจ |
| **ุฅูุชุงุฌ ููุท** | ุงูุฑุงุชุจ ุจูุงุกู ุนูู ุงูุฅูุชุงุฌ | ููุนุฑุถ ููุท | ูุง ููุฌุฏ | ูุง ููุฌุฏ |

---

## โ๏ธ ุงูุงุณุชุซูุงุกุงุช ูุงูุฃุฎุทุงุก

### 1. AttendanceProcessingException

#### ุฃ. ุชุฏุงุฎู ุงููุนุงูุฌุงุช (Overlapping Processing)
```php
// ูุญุฏุซ ุนูุฏูุง:
- ูุญุงููุฉ ูุนุงูุฌุฉ ูุชุฑุฉ ูุชุฏุงุฎูุฉ ูุน ูุนุงูุฌุฉ ุณุงุจูุฉ
- ููุณ ุงูููุธู + ููุณ ุงููุชุฑุฉ (ุฃู ุฌุฒุก ูููุง)

// ุงูุญู:
- ุญุฐู ุงููุนุงูุฌุฉ ุงูุณุงุจูุฉ
- ุฃู ุชุนุฏูู ุงููุชุฑุฉ ุงููุทููุจุฉ
```

#### ุจ. ููุธู ูุนุทู (Inactive Employee)
```php
// ูุญุฏุซ ุนูุฏูุง:
- ูุญุงููุฉ ูุนุงูุฌุฉ ููุธู ุจุญุงูุฉ "ูุนุทู"

// ุงูุฑุณุงูุฉ:
"โ ุงูููุธู {name} (ููุฏ: {id}) ูุนุทู ููุง ูููู ูุนุงูุฌุฉ ุจุตูุงุชู ุฃู ุฑูุงุชุจู."
```

#### ุฌ. ูุง ุชูุฌุฏ ุจุตูุงุช (No Attendance Records)
```php
// ูุญุฏุซ ุนูุฏูุง:
- ูุง ุชูุฌุฏ ุจุตูุงุช ูู ุงููุชุฑุฉ ุงููุญุฏุฏุฉ

// ุงูุฑุณุงูุฉ:
"โ ูุง ุชูุฌุฏ ุจุตูุงุช ููููุธููู ูู ุงููุณู '{department}' ูููุชุฑุฉ ูู {startDate} ุฅูู {endDate}."
```

### 2. SalaryCalculationException

#### ุฃ. ูุชุฑุฉ ุบูุฑ ุตุญูุญุฉ (Invalid Period)
```php
// ูุญุฏุซ ุนูุฏูุง:
- startDate > endDate

// ุงูุฑุณุงูุฉ:
"ุงููุชุฑุฉ ุบูุฑ ุตุญูุญุฉ: ูู {startDate} ุฅูู {endDate}"
```

#### ุจ. ููุงูุจุฉ ููููุฏุฉ (Missing Shift)
```php
// ูุญุฏุซ ุนูุฏูุง:
- ุงูููุธู ูุง ูููู ููุงูุจุฉ ูุญุฏุฏุฉ

// ุงูุฑุณุงูุฉ:
"ุงูููุธู (ููุฏ: {employeeId}) ูุง ูููู ููุงูุจุฉ ูุญุฏุฏุฉ."
```

---

## ๐ ุงููุธุงุฆู ุบูุฑ ุงููุชุฒุงููุฉ (Jobs)

### 1. ProcessAttendanceJob
```php
// ุงูุงุณุชุฎุฏุงู: ูุนุงูุฌุฉ ูุณู ูุงูู
// ุงููุฒุงูุง:
- ุชุฌูุจ timeout ูููุนุงูุฌุงุช ุงููุจูุฑุฉ
- ูุนุงูุฌุฉ ูู ุงูุฎูููุฉ
- ุฅุนุงุฏุฉ ุงููุญุงููุฉ (3 ูุญุงููุงุช)
- timeout: 10 ุฏูุงุฆู

// ุงูุงุณุชุฏุนุงุก:
AttendanceProcessingService::processDepartmentAsync($department, $startDate, $endDate, $notes);
```

### 2. ProcessSingleEmployeeJob
```php
// ุงูุงุณุชุฎุฏุงู: ูุนุงูุฌุฉ ููุธู ูุงุญุฏ
// ุงููุฒุงูุง:
- ูุนุงูุฌุฉ ูู ุงูุฎูููุฉ
- ุฅุนุงุฏุฉ ุงููุญุงููุฉ (3 ูุญุงููุงุช)
- timeout: 5 ุฏูุงุฆู

// ุงูุงุณุชุฏุนุงุก:
AttendanceProcessingService::processSingleEmployeeAsync($employee, $startDate, $endDate, $notes);
```

---

## ๐พ ุงูุชุฎุฒูู ุงููุคูุช (Caching)

### ุขููุฉ ุงูุชุฎุฒูู ุงููุคูุช
```php
// ุงูููุชุงุญ:
'employee_salary_{employee_id}_{startDate}_{endDate}'

// ูุฏุฉ ุงูุตูุงุญูุฉ:
3600 ุซุงููุฉ (ุณุงุนุฉ ูุงุญุฏุฉ)

// ุงูุฅุจุทุงู ุงูุชููุงุฆู:
- ุนูุฏ ุฅูุดุงุก/ุชุญุฏูุซ/ุญุฐู ุจุตูุฉ
- ูุชู ุฅุจุทุงู cache ุงูุดูุฑ ุงูุญุงูู ูุงูุดูุฑ ุงูุณุงุจู
```

### ููุงุฆุฏ ุงูุชุฎุฒูู ุงููุคูุช
- ุชุญุณูู ุงูุฃุฏุงุก ูููุนุงูุฌุงุช ุงููุชูุฑุฑุฉ
- ุชูููู ุงูุญูู ุนูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ุงุณุชุฌุงุจุฉ ุฃุณุฑุน ูููุณุชุฎุฏู

---

## ๐ ููุงุญุธุงุช ูููุฉ

### 1. ูุนุงูุฌุฉ ุงูุฅุฌุงุฒุงุช
- **ุฅุฌุงุฒุฉ ูุฏููุนุฉ**: ูุญุตู ุงูููุธู ุนูู ุณุงุนุงุช ูุงููุฉ (expectedHours)
- **ุฅุฌุงุฒุฉ ุบูุฑ ูุฏููุนุฉ**: ูุง ูุญุตู ุนูู ุณุงุนุงุช (0 ุณุงุนุงุช)

### 2. ุฃูุงู ุงูุฅุถุงูู (Overtime Days)
- ุฃูุงู ุงูุนูู ูู ุงูุนุทูุงุช/ุฃูุงู ุงูุฑุงุญุฉ
- ููุญุณุจ ุงูุฑุงุชุจ: `dailyRate ร additional_day_calculation`

### 3. ุงูููุงููุฉ ุนูู ุงููุนุงูุฌุฉ
- ุฅุฐุง ูุงู `total_salary < 0`: ุงูููุธู ูุฏูู ููุดุฑูุฉ โ ูุง ูุชู ุฅูุดุงุก ููุฏ ูุญุงุณุจู
- ุฅุฐุง ูุงู `total_salary >= 0`: ูุชู ุฅูุดุงุก ููุฏ ูุญุงุณุจู ููุฏูุน

### 4. ููุน ุงูุญุฐู
- ูุง ูููู ุญุฐู ุงููุนุงูุฌุงุช ุงููุนุชูุฏุฉ (`status = 'approved'`)
- ูููู ุญุฐู ุงููุนุงูุฌุงุช ุงููุนููุฉ ุฃู ุงููุฑููุถุฉ ููุท

### 5. ุงูุชุฏุงุฎู (Overlap)
- ุงููุธุงู ูููุน ุงููุนุงูุฌุฉ ุงููุชุฏุงุฎูุฉ ุชูุงูุงู
- ุญุชู ุงูุชุฏุงุฎู ุงูุฌุฒุฆู (ููู ูุงุญุฏ) ูุชู ุฑูุถู
- ูุชู ุนุฑุถ ุชูุงุตูู ูุงููุฉ ุนู ุงููุนุงูุฌุงุช ุงููุชุฏุงุฎูุฉ

---

## ๐ ููุงุท ุงูุชุญุณูู ุงููุญุชููุฉ

1. **ุชุญุณูู ุงูุฃุฏุงุก**: ุงุณุชุฎุฏุงู Queue ูููุนุงูุฌุงุช ุงููุจูุฑุฉ ุฏุงุฆูุงู
2. **ุชุญุณูู Cache**: ุฅุจุทุงู ุฃูุซุฑ ุฐูุงุกู ููู cache
3. **ุชุญุณูู ุงูุฑุณุงุฆู**: ุฑุณุงุฆู ุฎุทุฃ ุฃูุซุฑ ูุถูุญุงู ูููุณุชุฎุฏู
4. **ุฅุถุงูุฉ Logging**: ุชุณุฌูู ููุตู ููู ุฎุทูุฉ ูู ุงููุนุงูุฌุฉ
5. **ุฅุถุงูุฉ Reports**: ุชูุงุฑูุฑ ุฅุญุตุงุฆูุฉ ุนู ุงููุนุงูุฌุงุช

---

## ๐ ุงููุฑุงุฌุน

- `app/Services/AttendanceProcessingService.php`
- `app/Services/SalaryCalculationService.php`
- `app/Livewire/AttendanceProcessingManager.php`
- `app/Models/AttendanceProcessing.php`
- `app/Models/AttendanceProcessingDetail.php`
- `app/Models/Attendance.php`

---

---

## ๐ฐ ูุธุงู ุงูุฎุตููุงุช ูุงูุฌุฒุงุกุงุช

### 1. ุญุณุงุจ ุงูุฎุตููุงุช ุงูุดูุฑูุฉ

ูุชู ุญุณุงุจ ุงูุฎุตููุงุช ุจูุงุกู ุนูู:
- **ุงูุชุฃุฎูุฑุงุช ุงูุชู ุชุฌุงูุฒุช ุงูุญุฏ ุงููุณููุญ**: ุฅุฐุง ุชุฌุงูุฒ ุงูููุธู `allowed_late_days`ุ ูุชู ุฎุตู ูุตู ููู ููู ููู ุชุฃุฎูุฑ ุฅุถุงูู
- **ุงูุฅุฐููุงุช ุงูุชู ุชุฌุงูุฒุช ุงูุญุฏ ุงููุณููุญ**: ุฅุฐุง ุชุฌุงูุฒ ุงูููุธู `allowed_permission_days`ุ ูุชู ุฎุตู ูุตู ููู ููู ุฅุฐู ุฅุถุงูู

**ุตูุบุฉ ุงูุญุณุงุจ:**
```php
$halfDayDeduction = $dailyRate * 0.5;
$totalDeduction = ($lateDaysExceeded + $permissionsExceeded) * $halfDayDeduction;
```

### 2. ุงููููุฏ ุงููุญุงุณุจูุฉ ููุฎุตููุงุช

ุนูุฏ ุงูููุงููุฉ ุนูู ูุนุงูุฌุฉ ุงูุจุตูุงุช:
- ูุชู ุฅูุดุงุก ููุฏ ูุญุงุณุจู ููู ุฎุตู ุชููุงุฆู
- **Debit**: ุญุณุงุจ ุงูููุธู (ุญุณุงุจ ุงูุฌุฒุงุกุงุช ุงูุฎุงุต ุจู)
- **Credit**: ุญุณุงุจ ุงูุฌุฒุงุกุงุช ูุงูุฎุตููุงุช (21040201)
- **pro_type**: 75

### 3. ุฅุฏุงุฑุฉ ุงูุฎุตููุงุช ูุฏููุงู

ูููู ุฅุถุงูุฉ ุฎุตููุงุช ูุฏููุฉ ุนุจุฑ:
- ุตูุญุฉ ุฅุฏุงุฑุฉ ุงูููุงูุขุช ูุงูุฎุตููุงุช
- ูุชู ุฅูุดุงุก ููุฏ ูุญุงุณุจู ุนูุฏ ุงูููุงููุฉ ุนูู ุงูุฎุตู

---

## ๐ ูุธุงู ุงูููุงูุขุช ูุงูุญูุงูุฒ

### 1. ุฅุถุงูุฉ ุงูููุงูุขุช

ูููู ุฅุถุงูุฉ ููุงูุขุช ููููุธููู:
- ูุฏููุงู ุนุจุฑ ุตูุญุฉ ุฅุฏุงุฑุฉ ุงูููุงูุขุช ูุงูุฎุตููุงุช
- ุชููุงุฆูุงู ูู ุฎูุงู ูุธุงู ุงูุญูุงูุฒ (ุฅู ูุฌุฏ)

### 2. ุงููููุฏ ุงููุญุงุณุจูุฉ ููููุงูุขุช

ุนูุฏ ุงูููุงููุฉ ุนูู ุงูููุงูุฃุฉ:
- **Debit**: ุญุณุงุจ ุงูููุงูุขุช ูุงูุญูุงูุฒ (210402)
- **Credit**: ุญุณุงุจ ุงูููุธู (ุญุณุงุจ ุงูููุงูุขุช ุงูุฎุงุต ุจู)
- **pro_type**: 76

---

## ๐ต ูุธุงู ุงูุณูู

### 1. ุฅุฏุงุฑุฉ ุงูุณูู

ูููู ุฅุถุงูุฉ ุณูู ููููุธููู:
- ูุฏููุงู ุนุจุฑ ุตูุญุฉ ุฅุฏุงุฑุฉ ุงูุณูู
- ูุชู ุงูููุงููุฉ ุนูู ุงูุณูู ูุจู ุฅูุดุงุก ุงูููุฏ ุงููุญุงุณุจู

### 2. ุงููููุฏ ุงููุญุงุณุจูุฉ ููุณูู

ุนูุฏ ุงูููุงููุฉ ุนูู ุงูุณูู:
- **Debit**: ุญุณุงุจ ุงูููุธู (ุญุณุงุจ ุงูุณูู ุงูุฎุงุต ุจู)
- **Credit**: ุญุณุงุจ ุงูุณูู (110601)
- **pro_type**: 78

---

## ๐ ููุน ุฑุงุชุจ ุฌุฏูุฏ: "ุซุงุจุช + ุณุงุนุงุช ุนูู ูุฑู"

### 1. ุงููุตู

ููุน ุฑุงุชุจ ุฌุฏูุฏ ูุง ูุนุชูุฏ ุนูู ุงูุจุตูุงุช:
- **ุงูุฑุงุชุจ ุงูุซุงุจุช**: ุฑุงุชุจ ุดูุฑู ุซุงุจุช
- **ุฑุงุชุจ ุงูุณุงุนุงุช**: ุนุฏุฏ ุงูุณุงุนุงุช ุงููุฏุฎูุฉ ูุฏููุงู ร ุฃุฌุฑ ุงูุณุงุนุฉ

**ุงูุตูุบุฉ:**
```
ุงูุฑุงุชุจ ุงูููุงุฆู = ุงูุฑุงุชุจ ุงูุซุงุจุช + (ุนุฏุฏ ุงูุณุงุนุงุช ร ุฃุฌุฑ ุงูุณุงุนุฉ)
```

### 2. ูุนุงูุฌุฉ ุงูุฑุงุชุจ ุงููุฑู

- ูุชู ุฅุฏุฎุงู ุนุฏุฏ ุงูุณุงุนุงุช ูุฏููุงู ููู ููุธู
- ูููู ูุนุงูุฌุฉ ููุธู ูุงุญุฏ ุฃู ูุณู ูุงูู
- ูุชู ุญูุธ ุงููุชุงุฆุฌ ูู ุฌุฏูู `flexible_salary_processings`

### 3. ุงูููุงููุฉ ุนูู ุงูุฑุงุชุจ ุงููุฑู

ุนูุฏ ุงูููุงููุฉ ุนูู ุงููุนุงูุฌุฉ:
- ูุชู ุฅูุดุงุก ููุฏ ูุญุงุณุจู:
  - **Debit**: ุญุณุงุจ 5301 (ุฑูุงุชุจ ุงูููุธููู)
  - **Credit**: ุญุณุงุจ ุงูููุธู
  - **pro_type**: 77

---

## ๐ณ ุญุณุงุจ ุฑุตูุฏ ุงูููุธู ุงูููุงุฆู

### ุงูุตูุบุฉ ุงููุงููุฉ

```
ุงูุฑุตูุฏ ุงูููุงุฆู = 
    ุงูุฑุงุชุจ (ูู ุงูุจุตูุงุช ุฃู ุงูุฑุงุชุจ ุงููุฑู)
    + ุงูููุงูุขุช ูุงูุญูุงูุฒ
    - ุงูุฎุตููุงุช ูุงูุฌุฒุงุกุงุช
    - ุงูุณูู
```

### ุชุญุฏูุซ ุงูุฑุตูุฏ ุชููุงุฆูุงู

- ูุชู ุชุญุฏูุซ ุฑุตูุฏ ุญุณุงุจ ุงูููุธู ุชููุงุฆูุงู ุนูุฏ:
  - ุฅูุดุงุก ููุฏ ูุญุงุณุจู ููุฑุงุชุจ
  - ุฅูุดุงุก ููุฏ ูุญุงุณุจู ููููุงูุฃุฉ
  - ุฅูุดุงุก ููุฏ ูุญุงุณุจู ููุฎุตู
  - ุฅูุดุงุก ููุฏ ูุญุงุณุจู ููุณูู
- ูุชู ุชุญุฏูุซ ุฌููุน ุงูุญุณุงุจุงุช ุงูุฃุจ ุชููุงุฆูุงู ุนุจุฑ `JournalDetailObserver`

---

## ๐ ุงูุญุณุงุจุงุช ุงููุญุงุณุจูุฉ ููููุธู

ุนูุฏ ุฅูุดุงุก ููุธู ุฌุฏูุฏุ ูุชู ุฅูุดุงุก 4 ุญุณุงุจุงุช:

1. **ุญุณุงุจ ุงูุฑุงุชุจ ุงูุฃุณุงุณู**: ุชุญุช ุญุณุงุจ ุฑูุงุชุจ ุงูููุธููู (2102)
2. **ุญุณุงุจ ุงูุณูู**: ุชุญุช ุญุณุงุจ ุงูุณูู (110601)
3. **ุญุณุงุจ ุงูุฌุฒุงุกุงุช ูุงูุฎุตููุงุช**: ุชุญุช ุญุณุงุจ ุฌุฒุงุกุงุช ูุฎุตููุงุช ุงูููุธููู (21040201)
4. **ุญุณุงุจ ุงูููุงูุขุช ูุงูุญูุงูุฒ**: ุชุญุช ุญุณุงุจ ุงูููุงูุขุช ูุงูุญูุงูุฒ (210402)

---

## โ๏ธ ุงูุชุญูู ูู ุนุฏู ุงูุชูุฑุงุฑ

### ูู ุงููููุฏ ุงููุญุงุณุจูุฉ

- ูุชู ุงูุชุญูู ูู `journal_id` ูุจู ุฅูุดุงุก ููุฏ ุฌุฏูุฏ
- ุฅุฐุง ูุงู ุงูููุฏ ููุฌูุฏุงูุ ูุชู ุฅุฑุฌุงุน `journal_id` ุงูููุฌูุฏ
- ูุชู ุญูุธ `journal_id` ูู ุงูุณุฌู ุงููุฑุชุจุท

### ูู ุญุณุงุจ ุงูุฎุตููุงุช

- ูุชู ุงูุชุญูู ูู `attendance_processing_id` ูุจู ุญุณุงุจ ุงูุฎุตููุงุช
- ูุง ูุชู ุญุณุงุจ ููุณ ุงูุฎุตู ูุฑุชูู ูููุณ ุงููุชุฑุฉ

### ูู ุงูููุงููุฉ

- ูุชู ุงูุชุญูู ูู `status` ูุจู ุงูููุงููุฉ
- ูุง ูููู ุงูููุงููุฉ ุนูู ูุนุงูุฌุฉ ูุนุชูุฏุฉ ุจุงููุนู

---

**ุชุงุฑูุฎ ุงูุฅูุดุงุก**: {{ date('Y-m-d H:i:s') }}
**ุงูุฅุตุฏุงุฑ**: MASSAR 1.02
**Laravel Version**: 12
**Livewire Version**: 3

