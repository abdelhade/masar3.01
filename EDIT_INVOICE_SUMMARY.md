# โ ุชุนุฏูู ุงููุงุชูุฑุฉ - ููุฎุต ุงูุชูููุฐ

## ๐ ูุง ุชู ุฅูุฌุงุฒู:

### 1. ุชุญุฏูุซ Repository (InvoiceDataRepository.php)
โ ุชุญุฏูุซ method `getInvoiceForEdit()` ูุฅุฑุฌุงุน:
- ุจูุงูุงุช ุงููุงุชูุฑุฉ ูุงููุฉ (ุฑุฃุณ ุงููุงุชูุฑุฉ)
- ุงูุฃุตูุงู ูุน `operation_item_id` (ููู ุฌุฏุงู ููู Sync)
- ุงููุญุฏุงุช ุงููุชุงุญุฉ ููู ุตูู
- ุฌููุน ุงูุญุณุงุจุงุช (discount, vat, etc.)

### 2. ุชุญุฏูุซ ุตูุญุฉ Edit (edit.blade.php)
โ ุฅุนุงุฏุฉ ูุชุงุจุฉ ุงูุตูุญุฉ ุจุงููุงูู:
- ุชุตููู ูุชุฌุงูุจ ูุน Bootstrap 5
- ุชูุงูู ูุงูู ูุน Alpine.js
- ุนุฑุถ ุจูุงูุงุช ุงููุงุชูุฑุฉ
- ุฌุฏูู ุงูุฃุตูุงู ูุงุจู ููุชุนุฏูู
- ุญุณุงุจ ุงูุฅุฌูุงููุงุช ุชููุงุฆูุงู
- ุจุญุซ ูุฅุถุงูุฉ ุฃุตูุงู ุฌุฏูุฏุฉ
- ุญุฐู ุฃุตูุงู ููุฌูุฏุฉ

### 3. ุชุญุฏูุซ JavaScript (invoice-form.js)
โ ุชุญุฏูุซ methods:
- `loadInvoiceForEdit()`: ุชุญููู ุจูุงูุงุช ุงููุงุชูุฑุฉ ูุน ุงูุญูุงุธ ุนูู `operation_item_id`
- `saveInvoice()`: ุฅุฑุณุงู `operation_item_id` ูุน ูู ุตูู ููู Sync

### 4. ุงูู Backend ุฌุงูุฒ! โ
- `SaveInvoiceService::syncInvoiceItems()` ููุฌูุฏ ููุนูู
- `InvoiceController::update()` ููุฌูุฏ ููุนูู
- `RecalculationServiceHelper` ููุฌูุฏ ูุฅุนุงุฏุฉ ุญุณุงุจ ุงูุชูุงููู

---

## ๐ ููู ูุนูู ุงูุชุนุฏููุ

### ุนูุฏ ูุชุญ ุตูุญุฉ Edit:
```
1. GET /api/invoices/{id}/edit-data
   โ
2. InvoiceDataRepository::getInvoiceForEdit()
   โ
3. ุฅุฑุฌุงุน: invoice + items (ูุน operation_item_id)
   โ
4. Alpine.js ูุญูู ุงูุจูุงูุงุช ูู ุงูู Form
```

### ุนูุฏ ุงูุญูุธ:
```
1. ุงููุณุชุฎุฏู ูุนุฏู ุงูุจูุงูุงุช
   โ
2. Alpine.js ูุญุณุจ ุงูุฅุฌูุงููุงุช
   โ
3. PUT /api/invoices/{id}
   โ
4. InvoiceController::update()
   โ
5. SaveInvoiceService::saveInvoice($data, true)
   โ
6. syncInvoiceItems() ูููู ุจู:
   - UPDATE: ุงูุฃุตูุงู ุงูููุฌูุฏุฉ (ููุง operation_item_id)
   - INSERT: ุงูุฃุตูุงู ุงูุฌุฏูุฏุฉ (ุจุฏูู operation_item_id)
   - DELETE: ุงูุฃุตูุงู ุงููุญุฐููุฉ
   โ
7. RecalculationServiceHelper::recalculateAverageCost()
   โ
8. RecalculationServiceHelper::recalculateProfitsAndJournals()
```

---

## ๐ฏ ุงุณุชุฑุงุชูุฌูุฉ ูุฒุงููุฉ ุงูุฃุตูุงู (Sync Strategy)

### ุงูุฃุตูุงู ุงูููุฌูุฏุฉ (Existing Items):
```php
// ููุง operation_item_id
{
    "operation_item_id": 123,
    "item_id": 45,
    "quantity": 10,
    "price": 100
}
โ UPDATE operation_items WHERE id = 123
```

### ุงูุฃุตูุงู ุงูุฌุฏูุฏุฉ (New Items):
```php
// ุจุฏูู operation_item_id
{
    "operation_item_id": null,
    "item_id": 67,
    "quantity": 5,
    "price": 50
}
โ INSERT INTO operation_items
```

### ุงูุฃุตูุงู ุงููุญุฐููุฉ (Deleted Items):
```php
// ููุฌูุฏุฉ ูู DB ููู ูุด ููุฌูุฏุฉ ูู ุงูู Request
โ DELETE FROM operation_items WHERE id NOT IN (...)
```

---

## ๐ ุฅุนุงุฏุฉ ุญุณุงุจ ูุชูุณุท ุงูุชูููุฉ

### ุนูุฏ ุงูุชุนุฏูู:
```php
// 1. ุญูุธ ุงูุจูุงูุงุช ุงููุฏููุฉ
$oldItemIds = [1, 2, 3];
$oldOperationDate = '2024-01-15';

// 2. ุชุญุฏูุซ ุงููุงุชูุฑุฉ (Sync Items)

// 3. ุฅุนุงุฏุฉ ุงูุญุณุงุจ ูู ุชุงุฑูุฎ ุงููุงุชูุฑุฉ
RecalculationServiceHelper::recalculateAverageCost(
    $oldItemIds,      // ุงูุฃุตูุงู ุงููุชุฃุซุฑุฉ
    $oldOperationDate // ูู ุชุงุฑูุฎ ุงููุงุชูุฑุฉ ุงููุฏูู
);

// 4. ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุฃุฑุจุงุญ ููููุงุชูุฑ ุงููุงุญูุฉ
RecalculationServiceHelper::recalculateProfitsAndJournals(
    $oldItemIds,
    $oldOperationDate
);
```

### ููุงุฐุง ูู ุชุงุฑูุฎ ุงููุงุชูุฑุฉ ุงููุฏููุ
- ูุฃู ุชุนุฏูู ุงููุงุชูุฑุฉ ูุคุซุฑ ุนูู ุฌููุน ุงูููุงุชูุฑ ุงููุงุญูุฉ
- ูุชูุณุท ุงูุชูููุฉ ูุชุบูุฑ ุจูุงุกู ุนูู ุงูุชุฑุชูุจ ุงูุฒููู
- ุงูุฃุฑุจุงุญ ุชุญุชุงุฌ ุฅุนุงุฏุฉ ุญุณุงุจ ููููุงุชูุฑ ุงููุชุฃุซุฑุฉ

---

## ๐งช ููููุฉ ุงูุงุฎุชุจุงุฑ:

### 1. ูุชุญ ูุงุชูุฑุฉ ููุชุนุฏูู:
```
GET /invoices/form/{invoiceId}/edit
```

### 2. ุงูุชุญูู ูู ุชุญููู ุงูุจูุงูุงุช:
- โ ุฑุฃุณ ุงููุงุชูุฑุฉ (ุงูุชุงุฑูุฎุ ุงูุญุณุงุจุงุชุ ุฅูุฎ)
- โ ุงูุฃุตูุงู ูุน ุงููููุงุช ูุงูุฃุณุนุงุฑ
- โ ุงูุฅุฌูุงููุงุช (ุงูุฎุตูุ ุงูุถุฑูุจุฉุ ุฅูุฎ)

### 3. ุชุนุฏูู ุงูุจูุงูุงุช:
- โ ุชุนุฏูู ูููุฉ ุตูู ููุฌูุฏ
- โ ุชุนุฏูู ุณุนุฑ ุตูู ููุฌูุฏ
- โ ุฅุถุงูุฉ ุตูู ุฌุฏูุฏ
- โ ุญุฐู ุตูู ููุฌูุฏ
- โ ุชุนุฏูู ุงูุฎุตู ุนูู ูุณุชูู ุงููุงุชูุฑุฉ

### 4. ุงูุญูุธ:
- โ ุงูุชุญูู ูู ูุฌุงุญ ุงูุญูุธ
- โ ุงูุชุญูู ูู ุชุญุฏูุซ ุงูุจูุงูุงุช ูู DB
- โ ุงูุชุญูู ูู ุฅุนุงุฏุฉ ุญุณุงุจ ูุชูุณุท ุงูุชูููุฉ
- โ ุงูุชุญูู ูู ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุฃุฑุจุงุญ

---

## ๐ ููุงุญุธุงุช ูููุฉ:

### 1. ุงูููุงุชูุฑ ุงููุฑุญูุฉ (Posted):
```php
if ($existingOperation->is_posted ?? false) {
    throw new \Exception('ูุง ูููู ุชุนุฏูู ูุงุชูุฑุฉ ูุฑุญูุฉ (posted).');
}
```
โ ุงูููุงุชูุฑ ุงููุฑุญูุฉ ูุง ูููู ุชุนุฏูููุง

### 2. ุงูุตูุงุญูุงุช:
```php
$permissionName = 'edit ' . $this->titles[$type];
if (!$user->can($permissionName)) {
    abort(403);
}
```
โ ุงูุชุญูู ูู ุตูุงุญูุฉ ุงูุชุนุฏูู

### 3. ุงูุชุญูู ูู ุงููููุงุช:
```php
// ุงูุชุญูู ูู ุชููุฑ ุงููููุฉ ูู ุงููุฎุฒู
if ($availableQty < $quantityInBaseUnits) {
    throw new \Exception('ุงููููุฉ ุบูุฑ ูุชููุฑุฉ');
}
```
โ ุงูุชุญูู ูู ุงููููุงุช ุงููุชุงุญุฉ

### 4. ุญุฏ ุงูุงุฆุชูุงู:
```php
// ุงูุชุญูู ูู ุญุฏ ุงูุงุฆุชูุงู ููุนููุงุก
if ($balanceAfterInvoice > $customer->debit_limit) {
    throw new \Exception('ุชุฌุงูุฒ ุญุฏ ุงูุงุฆุชูุงู');
}
```
โ ุงูุชุญูู ูู ุญุฏ ุงูุงุฆุชูุงู

---

## ๐ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ:

โ ุตูุญุฉ Edit ูุงููุฉ ูุฌุงูุฒุฉ
โ ุชูุงูู ูุงูู ูุน ุงูู Backend
โ ูุฒุงููุฉ ุฐููุฉ ููุฃุตูุงู (Update/Insert/Delete)
โ ุฅุนุงุฏุฉ ุญุณุงุจ ุชููุงุฆูุฉ ููุชูุณุท ุงูุชูููุฉ ูุงูุฃุฑุจุงุญ
โ ูุงุฌูุฉ ูุณุชุฎุฏู ุณููุฉ ููุชุฌุงูุจุฉ
โ ุงูุชุญูู ูู ุงูุตูุงุญูุงุช ูุงููููุฏ

---

## ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ (ุงุฎุชูุงุฑู):

1. ุฅุถุงูุฉ Validation ุฃูุซุฑ ุชูุตููุงู
2. ุฅุถุงูุฉ History/Audit Log ููุชุนุฏููุงุช
3. ุฅุถุงูุฉ Notifications ุนูุฏ ุงูุชุนุฏูู
4. ุฅุถุงูุฉ Approval Workflow ููุชุนุฏููุงุช ุงููุจูุฑุฉ
5. ุฅุถุงูุฉ Batch Edit ูุชุนุฏูู ุนุฏุฉ ููุงุชูุฑ

---

ุชู ุจุญูุฏ ุงููู! ๐
