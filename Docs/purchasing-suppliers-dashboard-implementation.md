# خطة دمج: تقييم الموردين، تنبيهات التأخر، لوحة تحكم المشتريات

## الميزات المطلوبة

1. **تقييم الموردين وتنبيهات فورية عند تأخر المورد**
2. **توصيات شراء، تحليل الموردين، تنبيهات**
3. **لوحة تحكم وتقارير المشتريات + أفضل 5 موردين في الالتزام بالوقت**
4. **متوسط أسعار الشراء لكل منتج خلال آخر 6 أشهر + قائمة الطلبات المتأخرة**

---

## الوضع الحالي في النظام

| المكون | الوصف |
|--------|--------|
| **operhead** | جدول العمليات (فواتير، أوامر شراء، عروض أسعار). `pro_type`: 11=فاتورة مشتريات، 15=أمر شراء، 17=عرض سعر مورد. `acc1` = المورد (AccHead). |
| **workflow_state** | 0=مسودة، 1=مقدم، 2=معتمد، 3=أمر شراء، 4=فاتورة مشتريات، 5=منقول. أمر الشراء (15) له workflow_state=3 حتى يُحوَّل لفاتورة (11). |
| **expected_time** | عمود نصي في operhead (مستخدم في التصنيع). **لا يوجد حقل تاريخ استلام متوقع** لأوامر الشراء. |
| **Quality / SupplierRating** | تقييم يدوي للمورد (جودة، التزام بالتسليم، توثيق). يمكن ربطه ببيانات المشتريات لاحقاً. |
| **Reports** | تقارير موردين ومشتريات جاهزة (general-suppliers-*, general-purchases-*). |
| **Notifications** | موديول تنبيهات موجود (OrderNotification). |

---

## خطوات الدمج المقترحة

### 1. إضافة تاريخ الاستلام المتوقع لأوامر الشراء

- **Migration**: إضافة عمود `expected_delivery_date` (date, nullable) لجدول `operhead`.
- **الاستخدام**: يُملأ عند إنشاء/تعديل **أمر شراء** (pro_type=15) أو **عرض سعر من مورد** (17) إذا كان سيُحوَّل لأمر شراء.
- **واجهة المستخدم**: إظهار حقل "تاريخ الاستلام المتوقع" في نموذج إنشاء/تعديل أمر الشراء (Invoices Livewire).

بدون هذا الحقل لا يمكن تحديد "طلبات متأخرة" أو "التزام المورد بالوقت".

---

### 2. قائمة الطلبات المتأخرة

- **التعريف**: أوامر شراء (pro_type=15) بحالة workflow_state=3 (ما زالت أمر شراء ولم تُحوَّل لفاتورة)، و `expected_delivery_date < today`.
- **المكان**: تقرير/صفحة تحت تقارير المشتريات أو لوحة تحكم المشتريات.
- **البيانات المعروضة**: رقم الأمر، المورد، التاريخ المتوقع، عدد الأيام المتأخرة، رابط للمستند.

---

### 3. أفضل 5 موردين في الالتزام بالوقت (خلال فترة)

- **المصدر**: أوامر شراء (15) لها parent/origin، وتحوّلت لفاتورة مشتريات (11). ربط الفاتورة (11) بأمر الشراء (15) عبر `parent_id` أو `origin_id`.
- **الحساب**: لكل مورد (acc1):
  - عدد أوامر الشراء التي تحوّلت لفاتورة ومتوفّر لها `expected_delivery_date` (من أمر الشراء).
  - عدد ما تم استلامه في الوقت (تاريخ الفاتورة pro_date <= expected_delivery_date).
  - نسبة الالتزام = (تم في الوقت / الإجمالي) * 100.
- **الفترة**: فلتر من تاريخ – إلى تاريخ (مثلاً آخر 3 أو 6 أشهر).
- **العرض**: ترتيب تنازلي حسب نسبة الالتزام، عرض أفضل 5 في لوحة التحكم أو تقرير منفصل.

---

### 4. متوسط أسعار الشراء لكل منتج (آخر 6 أشهر)

- **المصدر**: `operation_items` + `operhead` حيث pro_type=11 (فاتورة مشتريات) و pro_date ضمن آخر 6 أشهر.
- **الحساب**: لكل صنف (item_id): متوسط السعر = SUM(qty_in * item_price) / SUM(qty_in) مع التصفية حسب التاريخ.
- **العرض**: تقرير أو جدول: اسم الصنف، متوسط السعر، آخر سعر شراء، عدد الفواتير، إجمالي الكمية. يمكن وضعه في نفس لوحة التحكم أو تقرير "مشتريات أصناف" مع فلتر 6 أشهر.

يوجد حالياً تقرير مشتريات أصناف (general-purchases-items / manage-item-purchase-report). يفضّل إما إضافة فلتر "آخر 6 أشهر" ومؤشر "متوسط السعر"، أو إنشاء تقرير فرعي "متوسط أسعار الشراء آخر 6 أشهر".

---

### 5. تنبيهات فورية عند تأخر المورد

- **الحدث**: أمر شراء (pro_type=15، workflow_state=3) و `expected_delivery_date` قد مضى (expected_delivery_date < today).
- **الإجراء المقترح**:
  - **Command مجدول (Cron)**: يومي يبحث عن الطلبات المتأخرة ويُنشئ تنبيهات للمستخدمين المعنيين (مشتريات، مدير).
  - أو **عند فتح لوحة التحكم**: استعلام الطلبات المتأخرة وعرضها كتنبيهات في الصفحة + إمكانية إنشاء إشعار في جدول notifications إذا وُجد.
- **ربط مع موديول Notifications**: استخدام نفس آلية الإشعارات (جدول notifications، عرض في الهيدر) مع نوع جديد مثل "تأخر مورد" أو "طلب شراء متأخر".

---

### 6. توصيات شراء وتحليل الموردين

- **توصيات شراء**: يمكن أن تعتمد على: أصناف تحت الحد الأدنى + تاريخياً من أي مورد تم الشراء. (يتطلب ربط بمخزون وحدود إعادة الطلب إن وُجدت.)
- **تحليل الموردين**: دمج بيانات تقييم الجودة (Quality SupplierRating) مع بيانات الالتزام بالوقت ومتوسط الأسعار من التقارير أعلاه، وعرضها في صفحة "ملخص مورد" أو في لوحة تحكم المشتريات.

---

## ترتيب التنفيذ المقترح

| # | المهمة | الملاحظات |
|---|--------|-----------|
| 1 | Migration: إضافة `expected_delivery_date` لـ operhead | أساس لباقي الميزات |
| 2 | إضافة الحقل في نموذج أمر الشراء (إنشاء/تعديل) | حتى يُدخل المستخدم التاريخ |
| 3 | خدمة/كونترولر: طلبات متأخرة + أفضل 5 موردين + متوسط أسعار 6 أشهر | لوحة تحكم أو تقارير |
| 4 | صفحة/route لوحة تحكم المشتريات | تجميع البطاقات والتقارير القصيرة |
| 5 | تنبيهات تأخر المورد (Command أو عند تحميل اللوحة + Notifications) | اختياري: إشعارات قاعدة بيانات |
| 6 | توصيات شراء وتحليل موردين متقدم | لاحق حسب وجود بيانات مخزون وحدود إعادة الطلب |

---

## الملفات المُنفَّذة (مرجع)

- `database/migrations/2026_01_29_120000_add_expected_delivery_date_to_operhead_table.php`
- `app/Models/OperHead.php`: إضافة cast لـ expected_delivery_date.
- `Modules/Reports/Http/Controllers/PurchasingDashboardController.php`: لوحة تحكم المشتريات، طلبات متأخرة، أفضل 5 موردين، متوسط أسعار 6 أشهر.
- `Modules/Reports/routes/reports/purchase.php`: روابط لوحة التحكم والطلبات المتأخرة.
- `Modules/Reports/Resources/views/purchasing/dashboard.blade.php` و `delayed-orders.blade.php`.
- `Modules/Invoices/`: نموذج أمر الشراء وعرض سعر من مورد (15، 17) يعرض حقل "تاريخ الاستلام المتوقع" ويحفظه.
- `app/Console/Commands/CheckDelayedPurchaseOrdersCommand.php`: أمر `php artisan purchasing:check-delayed-orders` لإنشاء تنبيهات للمستخدمين عند وجود طلبات متأخرة.

### جدولة تنبيهات التأخر (اختياري)

لتشغيل التنبيهات يومياً، أضف في `routes/console.php` (Laravel 11) أو في `app/Console/Kernel.php` (Laravel 10):

```php
Schedule::command('purchasing:check-delayed-orders')->daily();
```

بعد تنفيذ 1–4 يمكن اعتبار "تقييم الموردين، تنبيهات التأخر، لوحة تحكم وتقارير المشتريات، أفضل 5 موردين، ومتوسط أسعار 6 أشهر والطلبات المتأخرة" مدمجة في النظام. البند 5 يكمّل التنبيهات الفورية، والبند 6 يوسّع التحليل والتوصيات لاحقاً.
